name: Deploy site

on:
  push:
    branches:
      - master
      - main
    paths:
      - "assets/**"
      - "_sass/**"
      - "_scripts/**"
      - "**.bib"
      - "**.html"
      - "**.js"
      - "**.liquid"
      - "**/*.md"
      - "**.yml"
      - "Gemfile"
      - "Gemfile.lock"
      - "!.github/workflows/axe.yml"
      - "!.github/workflows/broken-links.yml"
      - "!.github/workflows/deploy-docker-tag.yml"
      - "!.github/workflows/deploy-image.yml"
      - "!.github/workflows/docker-slim.yml"
      - "!.github/workflows/lighthouse-badger.yml"
      - "!.github/workflows/prettier.yml"
      - "!lighthouse_results/**"
      - "!CONTRIBUTING.md"
      - "!CUSTOMIZE.md"
      - "!FAQ.md"
      - "!INSTALL.md"
      - "!README.md"
  pull_request:
    branches:
      - master
      - main
    paths:
      - "assets/**"
      - "_sass/**"
      - "_scripts/**"
      - "**.bib"
      - "**.html"
      - "**.js"
      - "**.liquid"
      - "**/*.md"
      - "**.yml"
      - "Gemfile"
      - "Gemfile.lock"
      - "!.github/workflows/axe.yml"
      - "!.github/workflows/broken-links.yml"
      - "!.github/workflows/deploy-docker-tag.yml"
      - "!.github/workflows/deploy-image.yml"
      - "!.github/workflows/docker-slim.yml"
      - "!.github/workflows/lighthouse-badger.yml"
      - "!.github/workflows/prettier.yml"
      - "!lighthouse_results/**"
      - "!CONTRIBUTING.md"
      - "!CUSTOMIZE.md"
      - "!FAQ.md"
      - "!INSTALL.md"
      - "!README.md"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    # available images: https://github.com/actions/runner-images#available-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        
      - name: Debug - Check Repository Structure
        run: |
          echo "=== ä»“åº“ç»“æ„æ£€æŸ¥ ==="
          ls -la
          echo "=== å…³é”®ç›®å½•æ£€æŸ¥ ==="
          [ -d "_pages" ] && echo "_pages ç›®å½•å­˜åœ¨" || echo "_pages ç›®å½•ä¸å­˜åœ¨"
          [ -d "_layouts" ] && echo "_layouts ç›®å½•å­˜åœ¨" || echo "_layouts ç›®å½•ä¸å­˜åœ¨"
          [ -d "_includes" ] && echo "_includes ç›®å½•å­˜åœ¨" || echo "_includes ç›®å½•ä¸å­˜åœ¨"
          [ -d "assets" ] && echo "assets ç›®å½•å­˜åœ¨" || echo "assets ç›®å½•ä¸å­˜åœ¨"
          echo "=== é…ç½®æ–‡ä»¶æ£€æŸ¥ ==="
          [ -f "_config.yml" ] && echo "_config.yml å­˜åœ¨" || echo "_config.yml ä¸å­˜åœ¨"
          [ -f "Gemfile" ] && echo "Gemfile å­˜åœ¨" || echo "Gemfile ä¸å­˜åœ¨"
          
      - name: Setup Ruby ğŸ’
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.5"
          bundler-cache: true
          
      - name: Debug - Check Ruby and Bundle
        run: |
          echo "=== Ruby ç¯å¢ƒæ£€æŸ¥ ==="
          ruby -v
          bundle -v
          bundle exec jekyll -v
          echo "=== Gem åˆ—è¡¨ ==="
          bundle list
          
      - name: Setup Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip" # caching pip dependencies
          
      - name: Update _config.yml âš™ï¸
        uses: fjogeleit/yaml-update-action@main
        with:
          commitChange: false
          valueFile: "_config.yml"
          propertyPath: "giscus.repo"
          value: ${{ github.repository }}
          
      - name: Install System Dependencies
        run: |
          echo "=== å®‰è£…ç³»ç»Ÿä¾èµ– ==="
          sudo apt-get update
          sudo apt-get install -y imagemagick
          pip3 install --upgrade nbconvert
          
      - name: Debug - Pre-build Check
        run: |
          echo "=== æ„å»ºå‰æ£€æŸ¥ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          echo "JEKYLL_ENV: $JEKYLL_ENV"
          
      - name: Install and Build ğŸ”§
        run: |
          echo "=== å¼€å§‹ Jekyll æ„å»º ==="
          export JEKYLL_ENV=production
          
          # æ£€æŸ¥ Jekyll é…ç½®
          echo "=== æ£€æŸ¥ Jekyll é…ç½® ==="
          bundle exec jekyll doctor || echo "Jekyll doctor å®Œæˆ"
          
          # æ˜¾ç¤ºæ„å»ºè¯¦æƒ…
          echo "=== è¯¦ç»†æ„å»ºè¿‡ç¨‹ ==="
          bundle exec jekyll build --trace --verbose
          
      - name: Debug - Post-build Analysis
        run: |
          echo "=== æ„å»ºååˆ†æ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "=== _site ç›®å½•æ£€æŸ¥ ==="
          if [ -d "_site" ]; then
            echo "_site ç›®å½•å­˜åœ¨"
            echo "_site ç›®å½•å¤§å°:"
            du -sh _site/
            echo "=== _site ç›®å½•å†…å®¹ ==="
            ls -la _site/
            echo "=== _site ç›®å½•ç»“æ„ ==="
            find _site/ -type f -name "*.html" | head -20
            echo "HTML æ–‡ä»¶æ€»æ•°: $(find _site/ -name "*.html" | wc -l)"
            echo "CSS æ–‡ä»¶æ€»æ•°: $(find _site/ -name "*.css" | wc -l)"
            echo "JS æ–‡ä»¶æ€»æ•°: $(find _site/ -name "*.js" | wc -l)"
            
            # æ£€æŸ¥å…³é”®æ–‡ä»¶
            echo "=== å…³é”®æ–‡ä»¶æ£€æŸ¥ ==="
            [ -f "_site/index.html" ] && echo "index.html å­˜åœ¨" || echo "index.html ä¸å­˜åœ¨"
            [ -f "_site/assets/css/main.css" ] && echo "main.css å­˜åœ¨" || echo "main.css ä¸å­˜åœ¨"
            
          else
            echo "é”™è¯¯: _site ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: Purge unused CSS ğŸ§¹
        run: |
          echo "=== å¼€å§‹ CSS æ¸…ç† ==="
          npm install -g purgecss
          purgecss -c purgecss.config.js
          echo "CSS æ¸…ç†å®Œæˆ"
          
      - name: Debug - Final Check before Deploy
        run: |
          echo "=== éƒ¨ç½²å‰æœ€ç»ˆæ£€æŸ¥ ==="
          echo "_site ç›®å½•æœ€ç»ˆçŠ¶æ€:"
          ls -la _site/
          echo "å‡†å¤‡éƒ¨ç½²çš„æ–‡ä»¶:"
          find _site/ -name "*.html" | head -10
          
      - name: Deploy ğŸš€
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: _site
          branch: gh-pages